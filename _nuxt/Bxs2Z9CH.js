import{K as e}from"#entry";import{b as t,d as n,e as r,f as i}from"./BHonhOiW.js";async function a(e,t=`gzip`){let n=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),r=new Response(new Blob([n])),i=r.body?.pipeThrough(new DecompressionStream(t)),a=await new Response(i).text();return JSON.parse(a)}function o(e,t){let n=s(e),r={...t};for(let e in r)n[e]===`json`&&r[e]&&r[e]!==`undefined`&&(r[e]=JSON.parse(r[e])),n[e]===`boolean`&&r[e]!==`undefined`&&(r[e]=!!r[e]);for(let e in r)r[e]===`NULL`&&(r[e]=void 0);return r}function s(e){let t=e.match(/FROM\s+(\w+)/);if(!t)return{};let n=i[c(t[1])];return n?.fields||{}}function c(e){return e.replace(/^_content_/,``)}let l;const u={},d={};function f(e){async function t(e){return l||(d._=d._||p(),l=await d._,Reflect.deleteProperty(d,`_`)),u[String(e)]||(d[String(e)]=d[String(e)]||m(e),await d[String(e)],u[String(e)]=`loaded`,Reflect.deleteProperty(d,String(e))),l}return{all:async(n,r)=>(await t(e),l.exec({sql:n,bind:r,rowMode:`object`,returnValue:`resultRows`}).map(e=>o(n,e))),first:async(n,r)=>(await t(e),o(n,l.exec({sql:n,bind:r,rowMode:`object`,returnValue:`resultRows`}).shift())),exec:async(n,r)=>{await t(e),await l.exec({sql:n,bind:r})}}}async function p(){if(!l){let t=await e(()=>import(`./cOCDMTiK.js`),[],import.meta.url).then(e=>e.default);globalThis.sqlite3ApiConfig={silent:!0,debug:(...e)=>console.debug(...e),warn:(...e)=>{String(e[0]).includes(`OPFS sqlite3_vfs`)||console.warn(...e)},error:(...e)=>console.error(...e),log:(...e)=>console.log(...e)};let n=await t();l=new n.oo1.DB}return l}async function m(e){if(window.sessionStorage.getItem(`previewToken`))return l;let i=null,o=`checksum_${e}`,s=`collection_${e}`,c=`matched`;try{let t=l.exec({sql:`SELECT * FROM ${r.info} where id = '${o}'`,rowMode:`object`,returnValue:`resultRows`}).shift();t?.version!==n[String(e)]&&(c=`mismatch`)}catch{c=`missing`}if(c!==`matched`){{let t=window.localStorage.getItem(`content_${o}`);t===n[String(e)]&&(i=window.localStorage.getItem(`content_${s}`))}if(!i){i=await t(void 0,String(e));try{window.localStorage.setItem(`content_${o}`,n[String(e)]),window.localStorage.setItem(`content_${s}`,i)}catch(e){console.error(`Database integrity check failed, rebuilding database`,e)}}let u=await a(i);await l.exec({sql:`DROP TABLE IF EXISTS ${r[String(e)]}`}),c===`mismatch`&&await l.exec({sql:`DELETE FROM ${r.info} WHERE id = '${o}'`});for(let e of u)try{await l.exec(e)}catch(e){console.error(`Error executing command`,e)}}return l}export{f as loadDatabaseAdapter};